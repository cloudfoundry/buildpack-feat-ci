#@ load("@ytt:data", "data")
#@yaml/text-templated-strings

resources:
- name: ci
  type: git
  icon: github-circle
  source:
    uri: https://github.com/cloudfoundry/buildpacks-feature-eng-ci
    branch: master
    paths:
    - tasks/metacnb/*
    - util/*

- name: buildpack
  type: git
  icon: github-circle
  source:
    uri: "git@github.com:cloudfoundry/(@= data.values.buildpack @)-cnb.git"
    private_key: ((cf-buildpacks-eng-github-ssh-key.private_key))
    branch: master

- name: version
  type: semver
  icon: tag
  source:
    initial_version: 0.0.0
    driver: gcs
    bucket: artifacts.cf-buildpacks.appspot.com
    key: "cnb-versions/(@= data.values.buildpack @)-family-version"
    json_key: ((gcp-service-account-key))

- name: cnb2cf
  type: git
  icon: github-circle
  source:
    uri: https://github.com/cloudfoundry/cnb2cf
    branch: master

- name: shimmed-buildpack
  type: s3
  icon: file-code
  source:
    bucket: buildpack-release-candidates
    regexp: "shims/(@= data.values.buildpack @)/(@= data.values.buildpack @)-buildpack-v(\\d+\\.\\d+\\.\\d+-rc\\.\\d+).zip"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

- name: buildpack-acceptance-tests
  type: git
  icon: github-circle
  source:
    uri: https://github.com/cloudfoundry/buildpack-acceptance-tests
    branch: master

- name: environment-lock
  type: pool
  icon: lock-open
  source:
    uri: git@github.com:cloudfoundry/public-buildpacks-ci-robots.git
    branch: master
    private_key: ((public-buildpacks-ci-robots-private-key.private_key))
    pool: edge-environments

- name: language-lock
  type: pool
  icon: lock-open
  source:
    uri: git@github.com:cloudfoundry/public-buildpacks-ci-robots
    branch: master
    pool: edge-shared-environments
    private_key: ((public-buildpacks-ci-robots-private-key.private_key))

- name: environments
  type: git
  icon: cloud-outline
  source:
    uri: git@github.com:cloudfoundry/buildpacks-envs.git
    branch: master
    private_key: ((buildpacks-envs-private-key.private_key))

jobs:
- name: package-rc
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: ci
    - get: version
      params:
        pre: rc
    - get: buildpack
      trigger: true
    - get: cnb2cf
  - task: package-shim
    file: ci/tasks/metacnb/shim/package/task.yml
    params:
      LANGUAGE: #@ data.values.buildpack
  - put: shimmed-buildpack
    params:
      file: shimmed-buildpack/*.zip
  - put: version
    params:
      file: version/version

- name: test-rc
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: ci
    - get: buildpack-acceptance-tests
    - get: environments
    - get: version
      passed:
      - package-rc
    - get: buildpack
      passed:
      - package-rc
    - put: environment-lock
      params:
        acquire: true
    - put: language-lock
      params:
        claim: #@ data.values.buildpack
    - get: shimmed-buildpack
      trigger: true
      passed:
      - package-rc
  - task: create-space
    file: ci/tasks/cf/create-space/task.yml
    params:
      DOMAIN: buildpacks-gcp.ci.cf-app.com
      ORG: pivotal
    input_mapping:
      lock: environment-lock
  - task: integration-tests
    file: ci/tasks/metacnb/shim/integration/task.yml
    privileged: true
    params:
      LANGUAGE: #@ data.values.buildpack
      GIT_TOKEN: ((buildpacks-github-token))
  ensure:
    in_parallel:
    - task: delete-space
      file: ci/tasks/cf/delete-space/task.yml
    - put: environment-lock
      params:
        release: environment-lock
    - put: language-lock
      params:
        release: language-lock

- name: release
  public: true
  serial: true
  plan:
  - in_parallel:
    - get: ci
    - get: release
    - get: version
      params:
        bump: patch
    - get: buildpack
      trigger: true
      passed:
      - integration-tests
  - task: prepare
    file: ci/tasks/metacnb/shim/prepare-release/task.yml
    params:
      LANGUAGE: #@ data.values.buildpack
      TRACKER_TOKEN: ((pivotal-tracker-api-token))
      GITHUB_TOKEN: ((buildpacks-github-token))
  - put: release
    params:
      body: artifacts/body
      commitish: artifacts/commitish
      name: artifacts/name
      tag: artifacts/tag
      globs:
        - artifacts/*.zip
        - artifacts/*.SHA256SUM.txt
  - put: version
    params:
      file: version/version
