#@ load("@ytt:data", "data")
#@yaml/text-templated-strings

resources:
- name: ci
  type: git
  icon: github-circle
  source:
    uri: https://github.com/cloudfoundry/buildpacks-feature-eng-ci
    branch: master
    paths:
    - tasks/metacnb/*
    - util/*

- name: buildpack
  type: git
  icon: github-circle
  source:
    uri: "git@github.com:cloudfoundry/(@= data.values.buildpack @)-cnb.git"
    private_key: ((cf-buildpacks-eng-github-ssh-key.private_key))
    branch: master

- name: version
  type: semver
  icon: tag
  source:
    initial_version: 0.0.0
    driver: gcs
    bucket: artifacts.cf-buildpacks.appspot.com
    key: "cnb-versions/(@= data.values.buildpack @)-family-version"
    json_key: ((gcp-service-account-key))

- name: cnb2cf
  type: git
  icon: github-circle
  source:
    uri: https://github.com/cloudfoundry/cnb2cf
    branch: master

- name: shimmed-buildpack
  type: s3
  source:
    bucket: buildpack-release-candidates
    regexp: "shims/(@= data.values.buildpack @)/(@= data.values.buildpack @)-buildpack-v(\\d+\\.\\d+\\.\\d+-rc\\.\\d+).zip"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

jobs:
- name: package-rc
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: ci
    - get: version
      params:
        pre: rc
    - get: buildpack
      trigger: true
    - get: cnb2cf
  - task: package-shim
    file: ci/tasks/metacnb/shim/package/task.yml
    params:
      LANGUAGE: #@ data.values.buildpack
  - put: shimmed-buildpack
    params:
      file: shimmed-buildpack/*.zip
  - put: version
    params:
      file: version/version
